{% extends 'admin_portal_base.html' %}

{% block title %}{% if form.instance.pk %}Edit Booking{% else %}New Booking{% endif %} - Hawwa Admin{% endblock %}

{% block page_title %}{% if form.instance.pk %}Edit Booking{% else %}New Booking{% endif %}{% endblock %}
{% block page_subtitle %}{% if form.instance.pk %}Update booking information{% else %}Create a new service appointment{% endif %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'core:admin_booking_list' %}">Bookings</a></li>
{% if form.instance.pk %}
    <li class="breadcrumb-item"><a href="{% url 'core:admin_booking_detail' form.instance.pk %}">Booking #{{ form.instance.pk|stringformat:"05d" }}</a></li>
    <li class="breadcrumb-item active">Edit</li>
{% else %}
    <li class="breadcrumb-item active">New Booking</li>
{% endif %}
{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" id="bookingForm">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Basic Booking Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-check text-primary me-2"></i>Booking Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.client.id_for_label }}" class="form-label fw-bold">
                                Client <span class="text-danger">*</span>
                            </label>
                            {{ form.client }}
                            {% if form.client.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.client.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                <a href="#" class="text-decoration-none" onclick="openClientModal()">
                                    <i class="fas fa-plus me-1"></i>Add New Client
                                </a>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.service.id_for_label }}" class="form-label fw-bold">
                                Service <span class="text-danger">*</span>
                            </label>
                            {{ form.service }}
                            {% if form.service.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.service.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Selected service pricing will be auto-filled</div>
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.scheduled_date.id_for_label }}" class="form-label fw-bold">
                                Appointment Date <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.scheduled_date }}
                                <span class="input-group-text">
                                    <i class="fas fa-calendar"></i>
                                </span>
                            </div>
                            {% if form.scheduled_date.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.scheduled_date.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.scheduled_time.id_for_label }}" class="form-label fw-bold">
                                Appointment Time <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.scheduled_time }}
                                <span class="input-group-text">
                                    <i class="fas fa-clock"></i>
                                </span>
                            </div>
                            {% if form.scheduled_time.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.scheduled_time.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Available slots will be shown based on date</div>
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.duration.id_for_label }}" class="form-label fw-bold">
                                Duration (minutes)
                            </label>
                            {{ form.duration }}
                            {% if form.duration.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.duration.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Leave blank to use service default duration</div>
                        </div>

                        <div class="col-md-6">
                            <label for="{{ form.participants.id_for_label }}" class="form-label fw-bold">
                                Number of Participants
                            </label>
                            {{ form.participants }}
                            {% if form.participants.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.participants.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Maximum capacity varies by service</div>
                        </div>

                        <div class="col-12">
                            <label for="{{ form.location.id_for_label }}" class="form-label fw-bold">
                                Service Location
                            </label>
                            {{ form.location }}
                            {% if form.location.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.location.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Leave blank to use service default location</div>
                        </div>

                        <div class="col-12">
                            <label for="{{ form.notes.id_for_label }}" class="form-label fw-bold">
                                Special Notes / Instructions
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.notes.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Any special requirements or instructions for this booking</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-dollar-sign text-success me-2"></i>Pricing Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="{{ form.service_fee.id_for_label }}" class="form-label fw-bold">
                                Service Fee (QAR)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">QAR</span>
                                {{ form.service_fee }}
                            </div>
                            {% if form.service_fee.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.service_fee.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Will be auto-filled based on selected service</div>
                        </div>

                        <div class="col-md-4">
                            <label for="{{ form.additional_charges.id_for_label }}" class="form-label fw-bold">
                                Additional Charges (QAR)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">QAR</span>
                                {{ form.additional_charges }}
                            </div>
                            {% if form.additional_charges.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.additional_charges.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Extra fees, materials, or travel costs</div>
                        </div>

                        <div class="col-md-4">
                            <label for="{{ form.discount.id_for_label }}" class="form-label fw-bold">
                                Discount (QAR)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">QAR</span>
                                {{ form.discount }}
                            </div>
                            {% if form.discount.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.discount.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Promotional discounts or special offers</div>
                        </div>

                        <div class="col-12">
                            <div class="bg-light rounded p-3">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-0">Total Amount Calculation:</h6>
                                        <small class="text-muted">Service Fee + Additional Charges - Discount</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="fs-4 fw-bold text-success" id="totalAmount">QAR 0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Preferences -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user-cog text-info me-2"></i>Client Preferences
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Preferred Language</label>
                            <select class="form-select" name="preferred_language">
                                <option value="">Select Language</option>
                                <option value="english">English</option>
                                <option value="arabic">Arabic</option>
                                <option value="hindi">Hindi</option>
                                <option value="urdu">Urdu</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-bold">Communication Method</label>
                            <select class="form-select" name="communication_method">
                                <option value="">Select Method</option>
                                <option value="email">Email</option>
                                <option value="sms">SMS</option>
                                <option value="whatsapp">WhatsApp</option>
                                <option value="phone">Phone Call</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-bold">Special Requirements</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="wheelchairAccess">
                                        <label class="form-check-label" for="wheelchairAccess">
                                            Wheelchair Access Required
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="femaleProvider">
                                        <label class="form-check-label" for="femaleProvider">
                                            Female Provider Preferred
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="homeService">
                                        <label class="form-check-label" for="homeService">
                                            Home Service Required
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Booking Status -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks text-warning me-2"></i>Booking Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.status.id_for_label }}" class="form-label fw-bold">
                            Current Status
                        </label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.status.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="form-check form-switch mb-3">
                        {{ form.is_urgent }}
                        <label class="form-check-label" for="{{ form.is_urgent.id_for_label }}">
                            <strong>Mark as Urgent</strong>
                            <div class="form-text">Urgent bookings get priority attention</div>
                        </label>
                    </div>

                    <div class="form-check form-switch">
                        {{ form.send_confirmation }}
                        <label class="form-check-label" for="{{ form.send_confirmation.id_for_label }}">
                            <strong>Send Confirmation Email</strong>
                            <div class="form-text">Automatically notify client about booking</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Selected Service Info -->
            <div class="card border-0 shadow-sm mb-4" id="serviceInfoCard" style="display: none;">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-spa text-primary me-2"></i>Service Information
                    </h5>
                </div>
                <div class="card-body">
                    <div id="serviceDetails">
                        <!-- Service details will be loaded here via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Available Time Slots -->
            <div class="card border-0 shadow-sm mb-4" id="timeSlotsCard" style="display: none;">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock text-info me-2"></i>Available Time Slots
                    </h5>
                </div>
                <div class="card-body">
                    <div id="availableSlots">
                        <!-- Available slots will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt text-warning me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>
                            {% if form.instance.pk %}Update Booking{% else %}Create Booking{% endif %}
                        </button>
                        
                        <button type="button" class="btn btn-outline-primary" onclick="saveDraft()">
                            <i class="fas fa-file-alt me-2"></i>Save as Draft
                        </button>
                        
                        {% if form.instance.pk %}
                            <a href="{% url 'core:admin_booking_detail' form.instance.pk %}" class="btn btn-outline-info">
                                <i class="fas fa-eye me-2"></i>View Booking
                            </a>
                            
                            <button type="button" class="btn btn-outline-secondary" onclick="duplicateBooking()">
                                <i class="fas fa-copy me-2"></i>Duplicate
                            </button>
                        {% endif %}
                        
                        <a href="{% url 'core:admin_booking_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to List
                        </a>
                    </div>
                </div>
            </div>

            <!-- Booking Reminders -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell text-warning me-2"></i>Reminder Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="reminder24h" checked>
                        <label class="form-check-label" for="reminder24h">
                            24 hours before appointment
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="reminder2h" checked>
                        <label class="form-check-label" for="reminder2h">
                            2 hours before appointment
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="followUp">
                        <label class="form-check-label" for="followUp">
                            Follow-up after service
                        </label>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Reminders will be sent via the client's preferred communication method
                    </small>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Client Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="first_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="last_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control" name="date_of_birth">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Gender</label>
                            <select class="form-select" name="gender">
                                <option value="">Select Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" name="address" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveClient()">
                    <i class="fas fa-save me-2"></i>Save Client
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialize form enhancements
    initFormEnhancements();
    
    // Auto-calculate total amount
    calculateTotal();
    
    // Load service details when service changes
    $('#{{ form.service.id_for_label }}').change(function() {
        loadServiceDetails($(this).val());
    });
    
    // Load available slots when date changes
    $('#{{ form.scheduled_date.id_for_label }}').change(function() {
        loadAvailableSlots();
    });
    
    // Auto-calculate total on price changes
    $('#{{ form.service_fee.id_for_label }}, #{{ form.additional_charges.id_for_label }}, #{{ form.discount.id_for_label }}').on('input', function() {
        calculateTotal();
    });

    // Form validation
    $('#bookingForm').on('submit', function(e) {
        if (!validateBookingForm()) {
            e.preventDefault();
        }
    });
});

function initFormEnhancements() {
    // Add Bootstrap classes to form fields
    $('input, select, textarea').addClass('form-control');
    $('input[type="checkbox"]').removeClass('form-control').addClass('form-check-input');
    
    // Initialize date and time pickers
    const today = new Date().toISOString().split('T')[0];
    $('#{{ form.scheduled_date.id_for_label }}').attr('min', today);
}

function calculateTotal() {
    const serviceFee = parseFloat($('#{{ form.service_fee.id_for_label }}').val()) || 0;
    const additionalCharges = parseFloat($('#{{ form.additional_charges.id_for_label }}').val()) || 0;
    const discount = parseFloat($('#{{ form.discount.id_for_label }}').val()) || 0;
    
    const total = serviceFee + additionalCharges - discount;
    $('#totalAmount').text('QAR ' + total.toFixed(2));
}

function loadServiceDetails(serviceId) {
    if (!serviceId) {
        $('#serviceInfoCard').hide();
        return;
    }
    
    // TODO: Implement AJAX call to load service details
    $.ajax({
        url: `/admin/services/${serviceId}/details/`,
        method: 'GET',
        success: function(data) {
            $('#serviceDetails').html(`
                <div class="text-center mb-3">
                    <img src="${data.image || '/static/images/service-placeholder.png'}" 
                         class="img-fluid rounded" style="max-height: 150px;">
                </div>
                <h6>${data.name}</h6>
                <p class="text-muted small">${data.description}</p>
                <div class="row g-2 text-center">
                    <div class="col-6">
                        <strong>Price:</strong><br>
                        QAR ${data.price}
                    </div>
                    <div class="col-6">
                        <strong>Duration:</strong><br>
                        ${data.duration} min
                    </div>
                </div>
            `);
            
            // Auto-fill service fee
            $('#{{ form.service_fee.id_for_label }}').val(data.price);
            calculateTotal();
            
            $('#serviceInfoCard').show();
        },
        error: function() {
            console.log('Failed to load service details');
            // Show basic service info card anyway
            $('#serviceInfoCard').show();
        }
    });
}

function loadAvailableSlots() {
    const date = $('#{{ form.scheduled_date.id_for_label }}').val();
    const serviceId = $('#{{ form.service.id_for_label }}').val();
    
    if (!date || !serviceId) {
        $('#timeSlotsCard').hide();
        return;
    }
    
    // TODO: Implement AJAX call to load available time slots
    const sampleSlots = [
        '09:00', '09:30', '10:00', '10:30', '11:00', '11:30',
        '14:00', '14:30', '15:00', '15:30', '16:00', '16:30'
    ];
    
    const slotsHtml = sampleSlots.map(slot => `
        <button type="button" class="btn btn-outline-primary btn-sm me-2 mb-2 time-slot" 
                onclick="selectTimeSlot('${slot}')">
            ${slot}
        </button>
    `).join('');
    
    $('#availableSlots').html(slotsHtml);
    $('#timeSlotsCard').show();
}

function selectTimeSlot(time) {
    $('.time-slot').removeClass('btn-primary').addClass('btn-outline-primary');
    event.target.classList.remove('btn-outline-primary');
    event.target.classList.add('btn-primary');
    
    $('#{{ form.scheduled_time.id_for_label }}').val(time);
}

function validateBookingForm() {
    let isValid = true;
    const requiredFields = [
        '{{ form.client.id_for_label }}',
        '{{ form.service.id_for_label }}',
        '{{ form.scheduled_date.id_for_label }}',
        '{{ form.scheduled_time.id_for_label }}'
    ];
    
    requiredFields.forEach(function(fieldId) {
        const field = $(`#${fieldId}`);
        if (!field.val()) {
            field.addClass('is-invalid');
            isValid = false;
        } else {
            field.removeClass('is-invalid').addClass('is-valid');
        }
    });
    
    // Validate appointment date is not in the past
    const selectedDate = new Date($('#{{ form.scheduled_date.id_for_label }}').val());
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (selectedDate < today) {
        $('#{{ form.scheduled_date.id_for_label }}').addClass('is-invalid');
        showToast('Appointment date cannot be in the past', 'error');
        isValid = false;
    }
    
    return isValid;
}

function saveDraft() {
    // Add hidden field to indicate draft status
    $('<input>').attr({
        type: 'hidden',
        name: 'save_as_draft',
        value: 'true'
    }).appendTo('#bookingForm');
    
    $('#bookingForm').submit();
}

function duplicateBooking() {
    if (confirm('Create a copy of this booking with a new date/time?')) {
        window.location.href = '{% url "core:admin_booking_create" %}?duplicate={{ form.instance.pk }}';
    }
}

function openClientModal() {
    $('#clientModal').modal('show');
}

function saveClient() {
    const formData = new FormData($('#clientForm')[0]);
    
    // TODO: Implement AJAX call to save client
    $.ajax({
        url: '{% url "accounts:client_create_ajax" %}',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            // Add new client to select dropdown
            const option = new Option(response.name, response.id, true, true);
            $('#{{ form.client.id_for_label }}').append(option).trigger('change');
            
            // Close modal and show success message
            $('#clientModal').modal('hide');
            showToast('Client created successfully', 'success');
        },
        error: function(xhr) {
            showToast('Error creating client', 'error');
        }
    });
}

function showToast(message, type) {
    // Use the global toast function from admin-portal.js
    if (window.hawwaAdmin && window.hawwaAdmin.showToast) {
        window.hawwaAdmin.showToast(message, type);
    }
}
</script>
{% endblock %}