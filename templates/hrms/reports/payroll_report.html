{% extends 'hrms/base.html' %}
{% load static %}
{% load hrms_filters %}

{% block title %}Payroll Reports - HRMS{% endblock %}

{% block extra_css %}
<link href="{% static 'hrms/css/reports.css' %}" rel="stylesheet">
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
<style>
    .payroll-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .metric-card {
        transition: transform 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">Payroll Reports</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'hrms:dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'hrms:reports' %}">Reports</a></li>
                            <li class="breadcrumb-item active">Payroll Reports</li>
                        </ol>
                    </nav>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportPayrollData('monthly', 'pdf')"><i class="fas fa-file-pdf text-danger"></i> Monthly Report (PDF)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPayrollData('quarterly', 'pdf')"><i class="fas fa-file-pdf text-danger"></i> Quarterly Report (PDF)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPayrollData('yearly', 'pdf')"><i class="fas fa-file-pdf text-danger"></i> Yearly Report (PDF)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPayrollData('monthly', 'csv')"><i class="fas fa-file-csv text-success"></i> Monthly Report (CSV)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPayrollData('quarterly', 'csv')"><i class="fas fa-file-csv text-success"></i> Quarterly Report (CSV)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportPayrollData('yearly', 'csv')"><i class="fas fa-file-csv text-success"></i> Yearly Report (CSV)</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Payroll Period Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-calendar-alt"></i> Report Period</h5>
                </div>
                <div class="card-body">
                    <form method="get" id="periodForm">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="period_type" class="form-label">Period Type</label>
                                <select name="period_type" id="period_type" class="form-select">
                                    <option value="monthly" {% if request.GET.period_type == "monthly" %}selected{% endif %}>Monthly</option>
                                    <option value="quarterly" {% if request.GET.period_type == "quarterly" %}selected{% endif %}>Quarterly</option>
                                    <option value="yearly" {% if request.GET.period_type == "yearly" %}selected{% endif %}>Yearly</option>
                                    <option value="custom" {% if request.GET.period_type == "custom" %}selected{% endif %}>Custom Range</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="month" class="form-label">Month</label>
                                <select name="month" id="month" class="form-select">
                                    <option value="">Select Month</option>
                                    {% for i in "123456789ABC"|make_list %}
                                        <option value="{{ forloop.counter }}" {% if request.GET.month == forloop.counter|stringformat:"s" %}selected{% endif %}>
                                            {{ forloop.counter|date:"F" }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="year" class="form-label">Year</label>
                                <select name="year" id="year" class="form-select">
                                    {% for year in years %}
                                    <option value="{{ year }}" {% if request.GET.year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="date_from" class="form-label">From Date</label>
                                <input type="date" name="date_from" id="date_from" class="form-control" value="{{ request.GET.date_from }}">
                            </div>
                            <div class="col-md-2">
                                <label for="date_to" class="form-label">To Date</label>
                                <input type="date" name="date_to" id="date_to" class="form-control" value="{{ request.GET.date_to }}">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="department" class="form-label">Department</label>
                                <select name="department" id="department" class="form-select">
                                    <option value="">All Departments</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %}>
                                        {{ dept.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search"></i> Generate Report
                                </button>
                                <a href="{% url 'hrms:payroll_report' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-refresh"></i> Reset
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Payroll Summary Cards -->
    {% if payroll_summary %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card payroll-summary">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-bar"></i> 
                        Payroll Summary 
                        {% if latest_period %}
                        - {{ latest_period.name }}
                        {% endif %}
                    </h5>
                    <div class="row">
                        <div class="col-md-2">
                            <div class="metric-card">
                                <h3 class="mb-1">{{ payroll_summary.total_basic|currency_format|default:"QAR 0.00" }}</h3>
                                <p class="mb-0 opacity-75">Total Basic Salary</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <h3 class="mb-1">{{ payroll_summary.total_allowances|currency_format|default:"QAR 0.00" }}</h3>
                                <p class="mb-0 opacity-75">Total Allowances</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <h3 class="mb-1">{{ payroll_summary.total_gross|currency_format|default:"QAR 0.00" }}</h3>
                                <p class="mb-0 opacity-75">Total Gross Pay</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <h3 class="mb-1 text-warning">{{ payroll_summary.total_deductions|currency_format|default:"QAR 0.00" }}</h3>
                                <p class="mb-0 opacity-75">Total Deductions</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <h3 class="mb-1 text-success">{{ payroll_summary.total_net|currency_format|default:"QAR 0.00" }}</h3>
                                <p class="mb-0 opacity-75">Total Net Pay</p>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="metric-card">
                                <h3 class="mb-1">{{ payroll_count|default:"0" }}</h3>
                                <p class="mb-0 opacity-75">Employees Paid</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Department-wise Breakdown -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-building"></i> Department-wise Breakdown</h5>
                </div>
                <div class="card-body">
                    <canvas id="departmentChart" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-chart-pie"></i> Payroll Components</h5>
                </div>
                <div class="card-body">
                    <canvas id="componentsChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Payroll Report Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="fas fa-table"></i> Detailed Payroll Report</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="payrollReportTable" class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Employee</th>
                                    <th>Department</th>
                                    <th>Period</th>
                                    <th>Basic Salary</th>
                                    <th>Housing Allowance</th>
                                    <th>Transport Allowance</th>
                                    <th>Gross Salary</th>
                                    <th>Deductions</th>
                                    <th>Net Salary</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in payroll_items %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if item.employee.avatar %}
                                            <img src="{{ item.employee.avatar.url }}" class="rounded-circle me-2" width="32" height="32" alt="Avatar">
                                            {% else %}
                                            <div class="bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <span class="text-white fw-bold">{{ item.employee.user.first_name|first }}{{ item.employee.user.last_name|first }}</span>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <strong>{{ item.employee.user.get_full_name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ item.employee.employee_id|default:"-" }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ item.employee.department.name|default:"-" }}</span>
                                    </td>
                                    <td>{{ item.payroll_period.name }}</td>
                                    <td><strong>{{ item.basic_salary|currency_format }}</strong></td>
                                    <td>{{ item.housing_allowance|currency_format|default:"-" }}</td>
                                    <td>{{ item.transport_allowance|currency_format|default:"-" }}</td>
                                    <td><strong class="text-success">{{ item.gross_salary|currency_format }}</strong></td>
                                    <td><span class="text-warning">{{ item.total_deductions|currency_format|default:"QAR 0.00" }}</span></td>
                                    <td><strong class="text-primary">{{ item.net_salary|currency_format }}</strong></td>
                                    <td>
                                        {% if item.status == 'approved' %}
                                        <span class="badge bg-success">Approved</span>
                                        {% elif item.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                        {% elif item.status == 'paid' %}
                                        <span class="badge bg-primary">Paid</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ item.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            {% if item.id and item.id != '' and item.id != None %}
                                            <a href="{% url 'hrms:payroll_slip' item.id %}" class="btn btn-outline-primary btn-sm" title="View Payslip">
                                                <i class="fas fa-file-invoice"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="downloadPayslip({{ item.id|default:'0' }})" title="Download PDF">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            {% else %}
                                            <span class="text-muted">No payslip available</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="11" class="text-center text-muted py-4">
                                        <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
                                        <br>
                                        No payroll data found for the selected period.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#payrollReportTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excel',
                title: 'Payroll Report',
                className: 'btn btn-success btn-sm'
            },
            {
                extend: 'pdf',
                title: 'Payroll Report',
                className: 'btn btn-danger btn-sm',
                orientation: 'landscape'
            },
            {
                extend: 'csv',
                title: 'Payroll Report',
                className: 'btn btn-info btn-sm'
            }
        ],
        responsive: true,
        pageLength: 25,
        order: [[0, 'asc']],
        columnDefs: [
            { orderable: false, targets: [10] }
        ]
    });

    // Initialize Charts
    initializeDepartmentChart();
    initializeComponentsChart();
});

function initializeDepartmentChart() {
    const ctx = document.getElementById('departmentChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['IT', 'HR', 'Finance', 'Operations', 'Sales'],
            datasets: [{
                label: 'Total Payroll',
                data: [450000, 280000, 320000, 180000, 350000],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'QAR ' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function initializeComponentsChart() {
    const ctx = document.getElementById('componentsChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Basic Salary', 'Housing Allowance', 'Transport Allowance', 'Other Allowances'],
            datasets: [{
                data: [70, 15, 8, 7],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function exportPayrollData(period, format) {
    const table = $('#payrollReportTable').DataTable();
    
    if (format === 'pdf') {
        table.button('.buttons-pdf').trigger();
    } else if (format === 'csv') {
        table.button('.buttons-csv').trigger();
    } else if (format === 'excel') {
        table.button('.buttons-excel').trigger();
    }
}

function downloadPayslip(payslipId) {
    window.open(`/hrms/payroll/payslip/${payslipId}/pdf/`, '_blank');
}

// Period type change handler
$('#period_type').change(function() {
    const periodType = $(this).val();
    
    if (periodType === 'custom') {
        $('#date_from, #date_to').prop('disabled', false);
        $('#month, #year').prop('disabled', true);
    } else {
        $('#date_from, #date_to').prop('disabled', true);
        $('#month, #year').prop('disabled', false);
    }
});

// Auto-submit form on filter changes
$('#period_type, #month, #year, #department').change(function() {
    $('#periodForm').submit();
});
</script>
{% endblock %}
