{% extends 'vendors/vendors_base.html' %}
{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block title %}Document Management - {% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
        <li class="breadcrumb-item"><a href="{% url 'vendors:dashboard' %}">Vendor Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Documents</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="h4 mb-0">
        <i class="fas fa-file-alt text-primary me-2"></i>
        Document Management
    </h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
        <i class="fas fa-upload"></i> Upload Document
    </button>
</div>

<!-- Verification Status -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h6 class="mb-0">Verification Status</h6>
                    {% if vendor_profile.is_verified %}
                        <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                            <i class="fas fa-check-circle me-1"></i>Verified
                        </span>
                    {% else %}
                        <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2">
                            <i class="fas fa-clock me-1"></i>Pending Verification
                        </span>
                    {% endif %}
                </div>
                
                <div class="progress mb-3" style="height: 8px;">
                    <div class="progress-bar bg-success" style="width: 75%"></div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="h4 text-primary">{{ documents.count }}</div>
                            <small class="text-muted">Documents Uploaded</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="h4 text-success">{{ documents|dictsort:"status"|slice:":3"|length }}</div>
                            <small class="text-muted">Verified</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <div class="h4 text-warning">{{ documents|dictsort:"status"|slice:"3:"|length }}</div>
                            <small class="text-muted">Pending Review</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <h6 class="card-title">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    Verification Requirements
                </h6>
                <div class="small text-muted mb-3">
                    Complete your verification to unlock all vendor features.
                </div>
                <div class="list-group list-group-flush small">
                    <div class="list-group-item px-0 py-1 d-flex align-items-center">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        Business License
                    </div>
                    <div class="list-group-item px-0 py-1 d-flex align-items-center">
                        <i class="fas fa-clock text-warning me-2"></i>
                        Professional Certification
                    </div>
                    <div class="list-group-item px-0 py-1 d-flex align-items-center">
                        <i class="fas fa-times-circle text-danger me-2"></i>
                        Insurance Certificate
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Categories -->
<div class="row mb-4">
    <div class="col-12">
        <div class="btn-group" role="group" aria-label="Document categories">
            <button class="btn btn-outline-primary active" onclick="filterDocuments('all')">
                All Documents ({{ documents.count }})
            </button>
            <button class="btn btn-outline-primary" onclick="filterDocuments('business')">
                Business (3)
            </button>
            <button class="btn btn-outline-primary" onclick="filterDocuments('professional')">
                Professional (2)
            </button>
            <button class="btn btn-outline-primary" onclick="filterDocuments('insurance')">
                Insurance (1)
            </button>
            <button class="btn btn-outline-primary" onclick="filterDocuments('other')">
                Other ({{ documents.count|add:"-6" }})
            </button>
        </div>
    </div>
</div>

<!-- Documents Grid -->
<div class="row" id="documentsContainer">
    {% for document in documents %}
    <div class="col-lg-4 col-md-6 mb-4 document-item" data-category="{{ document.document_type }}">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded p-2 me-3">
                            {% if document.document_type == 'business_license' %}
                                <i class="fas fa-certificate text-primary"></i>
                            {% elif document.document_type == 'professional_cert' %}
                                <i class="fas fa-award text-primary"></i>
                            {% elif document.document_type == 'insurance' %}
                                <i class="fas fa-shield-alt text-primary"></i>
                            {% elif document.document_type == 'identification' %}
                                <i class="fas fa-id-card text-primary"></i>
                            {% else %}
                                <i class="fas fa-file text-primary"></i>
                            {% endif %}
                        </div>
                        <div>
                            <h6 class="mb-1">{{ document.title }}</h6>
                            <small class="text-muted">{{ document.get_document_type_display }}</small>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ document.document_file.url }}" target="_blank">
                                <i class="fas fa-eye me-2"></i>View
                            </a></li>
                            <li><a class="dropdown-item" href="{{ document.document_file.url }}" download>
                                <i class="fas fa-download me-2"></i>Download
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" onclick="deleteDocument({{ document.id }})">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
                
                <div class="mb-3">
                    {% if document.status == 'approved' %}
                        <span class="badge bg-success bg-opacity-10 text-success">
                            <i class="fas fa-check-circle me-1"></i>Approved
                        </span>
                    {% elif document.status == 'rejected' %}
                        <span class="badge bg-danger bg-opacity-10 text-danger">
                            <i class="fas fa-times-circle me-1"></i>Rejected
                        </span>
                    {% else %}
                        <span class="badge bg-warning bg-opacity-10 text-warning">
                            <i class="fas fa-clock me-1"></i>Pending Review
                        </span>
                    {% endif %}
                </div>
                
                {% if document.description %}
                    <p class="small text-muted mb-3">{{ document.description|truncatewords:15 }}</p>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center text-muted small">
                    <span>Uploaded {{ document.uploaded_at|timesince }} ago</span>
                    {% if document.expiry_date %}
                        <span class="{% if document.expiry_date < today %}text-danger{% elif document.expiry_date < today|add_days:30 %}text-warning{% endif %}">
                            Expires {{ document.expiry_date|date:"M d, Y" }}
                        </span>
                    {% endif %}
                </div>
                
                {% if document.status == 'rejected' and document.rejection_reason %}
                    <div class="alert alert-danger mt-3 mb-0 py-2">
                        <small>
                            <strong>Rejected:</strong> {{ document.rejection_reason }}
                        </small>
                    </div>
                {% endif %}
            </div>
            
            {% if document.document_file %}
                <div class="card-footer bg-light border-0">
                    <div class="d-flex align-items-center justify-content-between">
                        <small class="text-muted">
                            <i class="fas fa-file me-1"></i>
                            {{ document.document_file.name|slice:"-20:" }}
                        </small>
                        <a href="{{ document.document_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="col-12">
        <div class="text-center text-muted py-5">
            <i class="fas fa-file-upload fa-3x mb-3 opacity-50"></i>
            <h5>No Documents Uploaded</h5>
            <p>Upload your first document to start the verification process.</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
                <i class="fas fa-upload"></i> Upload Document
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Required Documents Help -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0">
        <h6 class="mb-0">
            <i class="fas fa-question-circle text-info me-2"></i>
            Required Documents Guide
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-lg-6 mb-3">
                <h6 class="text-primary">Business Documents</h6>
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Business License:</strong> Valid business registration certificate
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Tax Registration:</strong> Tax identification certificate
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Commercial Registration:</strong> Chamber of Commerce certificate
                    </li>
                </ul>
            </div>
            <div class="col-lg-6 mb-3">
                <h6 class="text-primary">Professional Documents</h6>
                <ul class="list-unstyled small">
                    <li class="mb-2">
                        <i class="fas fa-award text-warning me-2"></i>
                        <strong>Professional Certification:</strong> Industry-specific qualifications
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-shield-alt text-info me-2"></i>
                        <strong>Insurance Certificate:</strong> Professional liability insurance
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-id-card text-secondary me-2"></i>
                        <strong>Identification:</strong> Government-issued ID or passport
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Document Type</label>
                        {{ form.document_type }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Document Title</label>
                        {{ form.title }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Document File</label>
                        {{ form.document_file }}
                        <div class="form-text">
                            Accepted formats: PDF, JPG, PNG. Maximum size: 10MB.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        {{ form.description }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expiry Date (Optional)</label>
                        {{ form.expiry_date }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Document
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Document management functions
function filterDocuments(category) {
    const documents = document.querySelectorAll('.document-item');
    const buttons = document.querySelectorAll('.btn-group button');
    
    // Update active button
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Show/hide documents
    documents.forEach(doc => {
        if (category === 'all' || doc.dataset.category === category) {
            doc.style.display = 'block';
        } else {
            doc.style.display = 'none';
        }
    });
}

function deleteDocument(documentId) {
    if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
        // AJAX call to delete document
        fetch(`/vendors/documents/${documentId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deleting document');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the document');
        });
    }
}

// File upload validation
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.querySelector('input[type="file"]');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    this.value = '';
                    return;
                }
                
                // Check file type
                const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Please upload a PDF, JPG, or PNG file');
                    this.value = '';
                    return;
                }
            }
        });
    }
});
</script>
{% endblock %}
