{% extends 'vendors/vendors_base.html' %}
{% load static %}
{% load humanize %}

{% block title %}My Bookings - Hawwa{% endblock %}

{% block page_title %}Booking Management{% endblock %}
{% block page_subtitle %}Manage all your service bookings and client appointments{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'vendors:dashboard' %}">Vendor Dashboard</a></li>
<li class="breadcrumb-item active">Bookings</li>
{% endblock %}

{% block admin_header_actions %}
<div class="header-actions">
    <div class="btn-group">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="fas fa-filter me-2"></i>Advanced Filters
        </button>
        <button class="btn btn-success" onclick="exportBookings()">
            <i class="fas fa-download me-2"></i>Export
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Booking Statistics -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="admin-stat-card">
                <div class="stat-icon bg-primary">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ total_bookings|default:0 }}</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="admin-stat-card">
                <div class="stat-icon bg-warning">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ pending_bookings|default:0 }}</div>
                    <div class="stat-label">Pending Review</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="admin-stat-card">
                <div class="stat-icon bg-info">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ todays_bookings|default:0 }}</div>
                    <div class="stat-label">Today's Bookings</div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="admin-stat-card">
                <div class="stat-icon bg-success">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">{{ monthly_revenue|floatformat:0|default:"0" }}</div>
                    <div class="stat-label">This Month (QAR)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Filter Tabs -->
    <div class="admin-card mb-4">
        <div class="admin-card-body p-3">
            <div class="booking-tabs">
                <button class="tab-btn active" data-status="all" onclick="filterByStatus('all')">
                    <i class="fas fa-th-large me-2"></i>All Bookings
                    <span class="badge">{{ total_bookings|default:0 }}</span>
                </button>
                <button class="tab-btn" data-status="pending" onclick="filterByStatus('pending')">
                    <i class="fas fa-hourglass-half me-2"></i>Pending
                    <span class="badge bg-warning">{{ pending_bookings|default:0 }}</span>
                </button>
                <button class="tab-btn" data-status="confirmed" onclick="filterByStatus('confirmed')">
                    <i class="fas fa-check-circle me-2"></i>Confirmed
                    <span class="badge bg-info">{{ confirmed_bookings|default:0 }}</span>
                </button>
                <button class="tab-btn" data-status="in_progress" onclick="filterByStatus('in_progress')">
                    <i class="fas fa-play-circle me-2"></i>In Progress
                    <span class="badge bg-primary">{{ in_progress_bookings|default:0 }}</span>
                </button>
                <button class="tab-btn" data-status="completed" onclick="filterByStatus('completed')">
                    <i class="fas fa-check me-2"></i>Completed
                    <span class="badge bg-success">{{ completed_bookings|default:0 }}</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bookings Table -->
    <div class="admin-card">
        <div class="admin-card-header d-flex justify-content-between align-items-center">
            <h5 class="admin-card-title mb-0">
                <i class="fas fa-list me-2"></i>Booking List
                {% if status_filter %}
                    - {{ status_filter|title }} Only
                {% endif %}
            </h5>
            <div class="view-toggle">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" data-view="table" onclick="toggleView('table')">
                        <i class="fas fa-table"></i>
                    </button>
                    <button class="btn btn-outline-primary" data-view="grid" onclick="toggleView('grid')">
                        <i class="fas fa-th"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="admin-card-body p-0">
            {% if bookings %}
                <!-- Table View -->
                <div id="tableView" class="bookings-table">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-header">
                                <tr>
                                    <th>Booking Details</th>
                                    <th>Client Information</th>
                                    <th>Service</th>
                                    <th>Schedule</th>
                                    <th>Status</th>
                                    <th>Amount</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for booking in bookings %}
                                <tr class="booking-row" data-status="{{ booking.status }}">
                                    <td>
                                        <div class="booking-id">
                                            <a href="{% url 'vendors:booking_detail' booking.id %}" class="booking-link">
                                                <strong># {{ booking.booking_number }}</strong>
                                            </a>
                                            <div class="booking-date">
                                                <i class="fas fa-calendar me-1"></i>{{ booking.created_at|date:"M d, Y H:i" }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="client-info">
                                            <div class="client-name">
                                                <i class="fas fa-user me-2"></i>{{ booking.user.get_full_name }}
                                            </div>
                                            {% if booking.client_phone %}
                                                <div class="client-contact">
                                                    <i class="fas fa-phone me-2"></i>{{ booking.client_phone }}
                                                </div>
                                            {% endif %}
                                            {% if booking.client_email %}
                                                <div class="client-contact">
                                                    <i class="fas fa-envelope me-2"></i>{{ booking.client_email }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="service-info">
                                            <div class="service-name">{{ booking.service.name }}</div>
                                            <div class="service-category">
                                                <span class="category-badge">{{ booking.service.category.name|default:"General" }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="schedule-info">
                                            <div class="schedule-date">
                                                <i class="fas fa-calendar-day me-2"></i>{{ booking.start_date|date:"M d, Y" }}
                                            </div>
                                            <div class="schedule-time">
                                                <i class="fas fa-clock me-2"></i>{{ booking.start_time|time:"H:i" }}
                                                {% if booking.end_time %}
                                                    - {{ booking.end_time|time:"H:i" }}
                                                {% endif %}
                                            </div>
                                            {% if booking.duration %}
                                                <div class="schedule-duration">
                                                    <i class="fas fa-hourglass-half me-2"></i>{{ booking.duration }} min
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="status-column">
                                            <span class="status-badge status-{{ booking.status }}">
                                                {{ booking.get_status_display }}
                                            </span>
                                            {% if booking.priority == 'urgent' %}
                                                <div class="priority-badge urgent">
                                                    <i class="fas fa-exclamation-triangle"></i> Urgent
                                                </div>
                                            {% elif booking.priority == 'high' %}
                                                <div class="priority-badge high">
                                                    <i class="fas fa-arrow-up"></i> High Priority
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="amount-info">
                                            <div class="total-amount">{{ booking.total_price|floatformat:0 }} QAR</div>
                                            {% if booking.items.exists %}
                                                <div class="extras-note">+ extras included</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="action-buttons">
                                            <a href="{% url 'vendors:booking_detail' booking.id %}" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if booking.status == 'pending' %}
                                                <button class="btn btn-success btn-sm" onclick="updateStatus({{ booking.id }}, 'confirmed')" title="Accept">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger btn-sm" onclick="updateStatus({{ booking.id }}, 'cancelled')" title="Decline">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            {% elif booking.status == 'confirmed' %}
                                                <button class="btn btn-info btn-sm" onclick="updateStatus({{ booking.id }}, 'in_progress')" title="Start Service">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            {% elif booking.status == 'in_progress' %}
                                                <button class="btn btn-success btn-sm" onclick="updateStatus({{ booking.id }}, 'completed')" title="Mark Complete">
                                                    <i class="fas fa-check-circle"></i>
                                                </button>
                                            {% endif %}
                                            <div class="btn-group">
                                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-h"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="{% url 'vendors:booking_detail' booking.id %}">
                                                        <i class="fas fa-eye me-2"></i>View Details
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="sendMessage({{ booking.id }})">
                                                        <i class="fas fa-message me-2"></i>Message Client
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="#" onclick="rescheduleBooking({{ booking.id }})">
                                                        <i class="fas fa-calendar-alt me-2"></i>Reschedule
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="cancelBooking({{ booking.id }})">
                                                        <i class="fas fa-ban me-2"></i>Cancel Booking
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Grid View (Hidden by default) -->
                <div id="gridView" class="bookings-grid d-none">
                    <div class="row g-3 p-4">
                        {% for booking in bookings %}
                        <div class="col-lg-4 col-md-6">
                            <div class="booking-card" data-status="{{ booking.status }}">
                                <div class="booking-header">
                                    <div class="booking-number"># {{ booking.booking_number }}</div>
                                    <div class="status-badge status-{{ booking.status }}">
                                        {{ booking.get_status_display }}
                                    </div>
                                </div>
                                <div class="booking-content">
                                    <div class="client-info">
                                        <h6>{{ booking.user.get_full_name }}</h6>
                                        <p class="service-name">{{ booking.service.name }}</p>
                                    </div>
                                    <div class="booking-meta">
                                        <div class="meta-item">
                                            <i class="fas fa-calendar-day"></i>
                                            {{ booking.start_date|date:"M d, Y" }}
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-clock"></i>
                                            {{ booking.start_time|time:"H:i" }}
                                        </div>
                                        <div class="meta-item">
                                            <i class="fas fa-dollar-sign"></i>
                                            {{ booking.total_price|floatformat:0 }} QAR
                                        </div>
                                    </div>
                                </div>
                                <div class="booking-actions">
                                    <a href="{% url 'vendors:booking_detail' booking.id %}" class="btn btn-outline-primary btn-sm">
                                        View Details
                                    </a>
                                    {% if booking.status == 'pending' %}
                                        <button class="btn btn-success btn-sm" onclick="updateStatus({{ booking.id }}, 'confirmed')">
                                            Accept
                                        </button>
                                    {% elif booking.status == 'confirmed' %}
                                        <button class="btn btn-info btn-sm" onclick="updateStatus({{ booking.id }}, 'in_progress')">
                                            Start
                                        </button>
                                    {% elif booking.status == 'in_progress' %}
                                        <button class="btn btn-success btn-sm" onclick="updateStatus({{ booking.id }}, 'completed')">
                                            Complete
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h4>No bookings found</h4>
                    {% if status_filter %}
                        <p>No bookings with status "{{ status_filter }}" were found.</p>
                        <button class="btn btn-primary" onclick="filterByStatus('all')">View All Bookings</button>
                    {% else %}
                        <p>When customers book your services, they'll appear here.</p>
                        <a href="{% url 'vendors:services' %}" class="btn btn-primary">Manage Your Services</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="statusModalLabel">
                    <i class="fas fa-edit me-2"></i>Update Booking Status
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="status-update-info">
                    <p>Are you sure you want to update this booking status?</p>
                    <div id="statusDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmStatusUpdate">
                    <i class="fas fa-check me-2"></i>Confirm Update
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="filterModalLabel">
                    <i class="fas fa-filter me-2"></i>Advanced Filters
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="get" id="advancedFilterForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="">All Statuses</option>
                                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
                                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Service</label>
                            <select name="service" class="form-select">
                                <option value="">All Services</option>
                                {% for service in vendor_services %}
                                <option value="{{ service.id }}">{{ service.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date From</label>
                            <input type="date" name="date_from" class="form-control" value="{{ date_from }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date To</label>
                            <input type="date" name="date_to" class="form-control" value="{{ date_to }}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-danger" onclick="clearFilters()">Clear All</button>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_css %}
<style>
.admin-stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    border: 1px solid #e9ecef;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.2s ease;
}

.admin-stat-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.stat-content {
    flex-grow: 1;
}

.stat-number {
    font-size: 1.75rem;
    font-weight: 700;
    color: #2d3748;
    line-height: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 0.25rem;
}

.booking-tabs {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.tab-btn {
    background: none;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab-btn.active {
    border-color: #0d6efd;
    background: #0d6efd;
    color: white;
}

.tab-btn:hover:not(.active) {
    border-color: #0d6efd;
    color: #0d6efd;
}

.tab-btn .badge {
    background: rgba(255,255,255,0.2);
    color: inherit;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}

.tab-btn.active .badge {
    background: rgba(255,255,255,0.3);
}

.view-toggle .btn-group .btn {
    padding: 0.5rem 0.75rem;
}

.table-header th {
    background: #f8f9fa;
    border: none;
    padding: 1rem 0.75rem;
    font-weight: 600;
    color: #2d3748;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}

.booking-row {
    border-bottom: 1px solid #e9ecef;
    transition: background-color 0.2s ease;
}

.booking-row:hover {
    background: #f8f9ff;
}

.booking-row td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
}

.booking-link {
    text-decoration: none;
    color: #0d6efd;
    font-weight: 600;
}

.booking-link:hover {
    color: #0056b3;
}

.booking-date {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.client-info .client-name {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.25rem;
}

.client-contact {
    font-size: 0.8rem;
    color: #6c757d;
    margin-bottom: 0.125rem;
}

.service-name {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.25rem;
}

.category-badge {
    background: #e7f3ff;
    color: #0d6efd;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.schedule-info div {
    margin-bottom: 0.25rem;
    font-size: 0.85rem;
    color: #495057;
}

.schedule-date {
    font-weight: 600;
}

.status-column {
    text-align: center;
}

.status-badge {
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-confirmed { background: #d1ecf1; color: #0c5460; }
.status-in_progress { background: #cff4fc; color: #055160; }
.status-completed { background: #d4edda; color: #155724; }
.status-cancelled { background: #f8d7da; color: #721c24; }

.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
    margin-top: 0.25rem;
}

.priority-badge.urgent {
    background: #f8d7da;
    color: #721c24;
}

.priority-badge.high {
    background: #fff3cd;
    color: #856404;
}

.amount-info .total-amount {
    font-weight: 700;
    color: #16a085;
    font-size: 1.1rem;
}

.extras-note {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.action-buttons {
    display: flex;
    gap: 0.25rem;
    justify-content: center;
}

.action-buttons .btn {
    padding: 0.375rem 0.5rem;
}

/* Grid View Styles */
.bookings-grid {
    padding: 1rem;
}

.booking-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.booking-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.booking-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e9ecef;
}

.booking-number {
    font-weight: 700;
    color: #0d6efd;
    font-size: 1.1rem;
}

.booking-content h6 {
    margin-bottom: 0.5rem;
    color: #2d3748;
}

.booking-content .service-name {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.booking-meta {
    margin-bottom: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    color: #495057;
}

.meta-item i {
    width: 16px;
    color: #6c757d;
}

.booking-actions {
    display: flex;
    gap: 0.5rem;
}

.booking-actions .btn {
    flex: 1;
    font-size: 0.85rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-icon {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 2rem;
    font-size: 3rem;
}

.empty-state h4 {
    color: #2d3748;
    margin-bottom: 1rem;
}

.empty-state p {
    color: #718096;
    margin-bottom: 2rem;
    font-size: 1.1rem;
}

/* Modal Enhancements */
.modal-content {
    border-radius: 12px;
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.status-update-info {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 1rem;
}

#statusDetails {
    font-family: 'Courier New', monospace;
    background: white;
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

/* Responsive Design */
@media (max-width: 768px) {
    .booking-tabs {
        justify-content: center;
    }
    
    .tab-btn {
        flex: 1;
        min-width: 120px;
        justify-content: center;
    }
    
    .admin-stat-card {
        padding: 1rem;
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
    }
    
    .stat-number {
        font-size: 1.5rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .action-buttons {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .action-buttons .btn {
        width: 100%;
    }
    
    .bookings-grid .row {
        margin: 0;
    }
    
    .bookings-grid .col-lg-4,
    .bookings-grid .col-md-6 {
        padding: 0.5rem;
    }
}

@media (max-width: 576px) {
    .booking-tabs {
        flex-direction: column;
    }
    
    .tab-btn {
        width: 100%;
        justify-content: space-between;
    }
    
    .header-actions .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .view-toggle {
        margin-top: 1rem;
    }
}
</style>
{% endblock %}

{% block admin_extra_js %}
<script>
let currentBookingId = null;
let currentStatus = null;
let currentView = 'table';

// Status management functions
function updateStatus(bookingId, newStatus) {
    currentBookingId = bookingId;
    currentStatus = newStatus;
    
    const statusText = {
        'confirmed': 'Accept this booking request',
        'cancelled': 'Decline this booking request',
        'in_progress': 'Start service for this booking',
        'completed': 'Mark this booking as completed'
    };
    
    const statusDetails = `
        <div class="row">
            <div class="col-6"><strong>Booking ID:</strong></div>
            <div class="col-6">#${bookingId}</div>
        </div>
        <div class="row">
            <div class="col-6"><strong>Action:</strong></div>
            <div class="col-6">${statusText[newStatus] || newStatus}</div>
        </div>
        <div class="row">
            <div class="col-6"><strong>New Status:</strong></div>
            <div class="col-6"><span class="status-badge status-${newStatus}">${newStatus.replace('_', ' ').toUpperCase()}</span></div>
        </div>
    `;
    
    document.getElementById('statusDetails').innerHTML = statusDetails;
    
    const modal = new bootstrap.Modal(document.getElementById('statusModal'));
    modal.show();
}

// Filter functions
function filterByStatus(status) {
    const buttons = document.querySelectorAll('.tab-btn');
    const rows = document.querySelectorAll('.booking-row');
    const cards = document.querySelectorAll('.booking-card');
    
    // Update active button
    buttons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-status') === status);
    });
    
    // Filter table rows
    rows.forEach(row => {
        const rowStatus = row.getAttribute('data-status');
        row.style.display = (status === 'all' || rowStatus === status) ? 'table-row' : 'none';
    });
    
    // Filter grid cards
    cards.forEach(card => {
        const cardStatus = card.getAttribute('data-status');
        card.parentElement.style.display = (status === 'all' || cardStatus === status) ? 'block' : 'none';
    });
}

// View toggle functions
function toggleView(view) {
    currentView = view;
    
    const tableView = document.getElementById('tableView');
    const gridView = document.getElementById('gridView');
    const buttons = document.querySelectorAll('[data-view]');
    
    // Update active button
    buttons.forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-view') === view);
    });
    
    // Toggle views
    if (view === 'table') {
        tableView.classList.remove('d-none');
        gridView.classList.add('d-none');
    } else {
        tableView.classList.add('d-none');
        gridView.classList.remove('d-none');
    }
    
    // Store preference
    localStorage.setItem('bookingsView', view);
}

// Additional booking actions
function sendMessage(bookingId) {
    // Redirect to messaging or open messaging modal
    window.location.href = `/vendors/bookings/${bookingId}/message/`;
}

function rescheduleBooking(bookingId) {
    // Open reschedule modal or redirect
    window.location.href = `/vendors/bookings/${bookingId}/reschedule/`;
}

function cancelBooking(bookingId) {
    if (confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
        updateStatus(bookingId, 'cancelled');
    }
}

function exportBookings() {
    // Export bookings to CSV/Excel
    window.open('/vendors/bookings/export/', '_blank');
}

function clearFilters() {
    document.getElementById('advancedFilterForm').reset();
    window.location.href = window.location.pathname;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Restore view preference
    const savedView = localStorage.getItem('bookingsView');
    if (savedView && savedView !== currentView) {
        toggleView(savedView);
    }
    
    // Status update confirmation
    document.getElementById('confirmStatusUpdate').addEventListener('click', function() {
        if (currentBookingId && currentStatus) {
            const btn = this;
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
            
            fetch(`/vendors/bookings/${currentBookingId}/update-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `status=${currentStatus}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error updating status: ' + (data.message || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the status.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
            modal.hide();
        }
    });
    
    // Real-time updates (optional - using WebSocket or polling)
    // You can implement real-time booking updates here
    
    // Auto-refresh every 5 minutes for pending bookings
    if (document.querySelector('.status-pending')) {
        setInterval(() => {
            if (document.visibilityState === 'visible') {
                // Subtle refresh indication
                const refreshIndicator = document.createElement('div');
                refreshIndicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i>';
                refreshIndicator.className = 'position-fixed top-0 end-0 p-3 text-primary';
                document.body.appendChild(refreshIndicator);
                
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }, 300000); // 5 minutes
    }
});
</script>
{% endblock %}