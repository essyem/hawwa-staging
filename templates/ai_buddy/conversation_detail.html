{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ conversation.title }} - AI Buddy Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 70vh;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px 10px 0 0;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        max-height: 50vh;
    }
    
    .message {
        margin-bottom: 1rem;
        animation: fadeInUp 0.3s ease;
    }
    
    .message-user {
        text-align: right;
    }
    
    .message-ai {
        text-align: left;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 20px;
        word-wrap: break-word;
    }
    
    .message-user .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message-ai .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #666;
        margin-top: 0.25rem;
    }
    
    .chat-input-container {
        padding: 1rem;
        background: white;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 10px 10px;
    }
    
    .chat-input {
        border: 1px solid #e0e0e0;
        border-radius: 25px;
        padding: 0.75rem 1rem;
        resize: none;
    }
    
    .chat-send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .chat-send-btn:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        transform: scale(1.05);
        color: white;
    }
    
    .chat-send-btn:disabled {
        background: #ccc;
        transform: none;
    }
    
    .typing-indicator {
        display: none;
        text-align: left;
        margin-bottom: 1rem;
    }
    
    .typing-indicator .message-bubble {
        background: white;
        border: 1px solid #e0e0e0;
        color: #666;
        font-style: italic;
    }
    
    .typing-dots {
        display: inline-block;
    }
    
    .typing-dots::after {
        content: '';
        animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
        0%, 20% { content: ''; }
        40% { content: '.'; }
        60% { content: '..'; }
        80%, 100% { content: '...'; }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .ai-buddy-info {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
    
    .wellness-quick-log {
        background: #e8f4fd;
        border: 1px solid #bee5eb;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Chat Container -->
            <div class="card chat-container">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">{{ conversation.title }}</h5>
                            <small class="opacity-75">
                                <i class="fas fa-robot me-1"></i>
                                AI Buddy â€¢ Online
                            </small>
                        </div>
                        <div>
                            <a href="{% url 'ai_buddy:home' %}" class="btn btn-sm btn-light">
                                <i class="fas fa-arrow-left me-1"></i>
                                Back
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    {% for message in messages %}
                    <div class="message message-{{ message.sender }}">
                        <div class="message-bubble">
                            {{ message.content|linebreaks }}
                        </div>
                        <div class="message-time">
                            {{ message.created_at|date:"M d, H:i" }}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Typing indicator -->
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="message-bubble">
                            <i class="fas fa-robot me-2"></i>
                            AI Buddy is typing<span class="typing-dots"></span>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="input-group">
                        <textarea class="form-control chat-input" 
                                  id="messageInput" 
                                  placeholder="Type your message here..." 
                                  rows="2"></textarea>
                        <button class="btn chat-send-btn" id="sendBtn" type="button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- AI Buddy Info -->
            <div class="ai-buddy-info">
                <h6 class="mb-2">
                    <i class="fas fa-robot me-2"></i>
                    Your AI Companion
                </h6>
                <p class="mb-0 small">
                    I'm here to support you through your postpartum journey. Ask me about feeding, 
                    sleep, wellness, or anything on your mind. I'm available 24/7!
                </p>
            </div>
            
            <!-- Quick Wellness Log -->
            <div class="wellness-quick-log">
                <h6 class="mb-3">
                    <i class="fas fa-heart text-danger me-2"></i>
                    Quick Wellness Check
                </h6>
                <form id="quickWellnessForm">
                    {% csrf_token %}
                    <div class="mb-2">
                        <label class="form-label small">How are you feeling today?</label>
                        <select class="form-select form-select-sm" id="quickMood">
                            <option value="">Select mood...</option>
                            <option value="1">Very Low</option>
                            <option value="3">Low</option>
                            <option value="5">Okay</option>
                            <option value="7">Good</option>
                            <option value="10">Excellent</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small">Energy Level</label>
                        <select class="form-select form-select-sm" id="quickEnergy">
                            <option value="">Select energy...</option>
                            <option value="1">Very Tired</option>
                            <option value="3">Tired</option>
                            <option value="5">Average</option>
                            <option value="7">Energetic</option>
                            <option value="10">Very Energetic</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-plus me-1"></i>
                        Log Wellness
                    </button>
                </form>
            </div>
            
            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightning-bolt text-warning me-2"></i>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="insertQuickMessage('I have a question about feeding my baby')">
                            <i class="fas fa-baby me-1"></i>
                            Feeding Questions
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="insertQuickMessage('I need help with sleep schedules')">
                            <i class="fas fa-moon me-1"></i>
                            Sleep Help
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="insertQuickMessage('I\'m feeling overwhelmed today')">
                            <i class="fas fa-heart me-1"></i>
                            Emotional Support
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="insertQuickMessage('Can you suggest some wellness activities?')">
                            <i class="fas fa-spa me-1"></i>
                            Wellness Tips
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatMessages = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    const quickWellnessForm = document.getElementById('quickWellnessForm');
    
    // Auto-scroll to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Initial scroll
    scrollToBottom();
    
    // Send message function
    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Disable send button
        sendBtn.disabled = true;
        messageInput.disabled = true;
        
        // Add user message to chat
        addMessageToChat('user', message);
        messageInput.value = '';
        
        // Show typing indicator
        typingIndicator.style.display = 'block';
        scrollToBottom();
        
        // Send message to server
        fetch('{% url "ai_buddy:send_message" conversation.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                content: message
            })
        })
        .then(response => response.json())
        .then(data => {
            // Hide typing indicator
            typingIndicator.style.display = 'none';
            
            if (data.success) {
                // Get AI response
                return fetch('{% url "ai_buddy:get_ai_response" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        conversation_id: '{{ conversation.id }}'
                    })
                });
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addMessageToChat('ai', data.response);
            } else {
                addMessageToChat('ai', 'Sorry, I encountered an error. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            typingIndicator.style.display = 'none';
            addMessageToChat('ai', 'Sorry, I encountered an error. Please try again.');
        })
        .finally(() => {
            // Re-enable inputs
            sendBtn.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        });
    }
    
    // Add message to chat UI
    function addMessageToChat(sender, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${sender}`;
        
        const now = new Date();
        const timeString = now.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${content.replace(/\n/g, '<br>')}
            </div>
            <div class="message-time">
                ${timeString}
            </div>
        `;
        
        chatMessages.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }
    
    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Quick wellness logging
    quickWellnessForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const mood = document.getElementById('quickMood').value;
        const energy = document.getElementById('quickEnergy').value;
        
        if (!mood || !energy) {
            alert('Please select both mood and energy level.');
            return;
        }
        
        fetch('{% url "ai_buddy:log_wellness" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                mood_scale: parseInt(mood),
                energy_level: parseInt(energy),
                sleep_hours: 8,  // Default
                notes: 'Quick log from chat'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reset form
                quickWellnessForm.reset();
                
                // Add confirmation message
                addMessageToChat('ai', 'Thank you for logging your wellness! I\'ve noted that you\'re feeling ' + 
                    (mood >= 7 ? 'good' : mood >= 5 ? 'okay' : 'low') + 
                    ' today with ' + (energy >= 7 ? 'high' : energy >= 5 ? 'moderate' : 'low') + ' energy.');
            } else {
                alert('Error logging wellness: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error logging wellness. Please try again.');
        });
    });
});

// Quick message insertion
function insertQuickMessage(message) {
    document.getElementById('messageInput').value = message;
    document.getElementById('messageInput').focus();
}
</script>
{% endblock %}