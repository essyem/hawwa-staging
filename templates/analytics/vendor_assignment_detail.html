{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ vendor.business_name }} - Assignment Detail - Analytics - Hawwa{% endblock %}

{% block extra_css %}
<style>
    .vendor-header {
        background: var(--gradient-primary);
        color: white;
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .assignment-card {
        border: none;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        transition: var(--transition-normal);
        background: var(--card-bg);
        color: var(--text-primary);
    }
    
    .assignment-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .metric-box {
        text-align: center;
        padding: 1.5rem;
        border-radius: var(--radius-md);
        background: var(--card-bg-secondary);
        border: 1px solid var(--card-border);
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--qatar-maroon);
        margin-bottom: 0.5rem;
    }
    
    .metric-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .assignment-status {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.35rem 0.75rem;
        border-radius: 1rem;
    }
    
    .status-active {
        background: rgba(5, 150, 105, 0.1);
        color: var(--success);
    }
    
    .status-completed {
        background: rgba(59, 130, 246, 0.1);
        color: var(--info);
    }
    
    .status-cancelled {
        background: rgba(220, 38, 38, 0.1);
        color: var(--error);
    }
    
    .priority-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
    }
    
    .priority-urgent {
        background: var(--error);
        color: white;
    }
    
    .priority-high {
        background: var(--warning);
        color: white;
    }
    
    .priority-normal {
        background: var(--gray-400);
        color: white;
    }
    
    .availability-calendar {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: var(--radius-md);
        padding: 1rem;
    }
    
    .calendar-day {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-fast);
        margin: 2px;
    }
    
    .calendar-day.available {
        background: rgba(5, 150, 105, 0.1);
        color: var(--success);
    }
    
    .calendar-day.busy {
        background: rgba(220, 38, 38, 0.1);
        color: var(--error);
    }
    
    .calendar-day.selected {
        background: var(--qatar-maroon);
        color: white;
    }
    
    .performance-chart {
        height: 300px;
        position: relative;
    }
    
    .vendor-score {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        margin: 0 auto 1rem;
    }
    
    .score-excellent {
        background: var(--success);
    }
    
    .score-good {
        background: var(--info);
    }
    
    .score-average {
        background: var(--warning);
    }
    
    .assignment-timeline {
        position: relative;
        padding-left: 2rem;
    }
    
    .assignment-timeline::before {
        content: '';
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--border-color);
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: var(--radius-md);
        padding: 1rem;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 1rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--qatar-maroon);
        border: 2px solid var(--card-bg);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Vendor Header -->
    <div class="vendor-header">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center">
                    <div class="vendor-score score-excellent me-4">
                        {{ vendor.assignment_score|default:"92" }}
                    </div>
                    <div>
                        <h2 class="mb-1">{{ vendor.business_name|default:"Premium Wellness Spa" }}</h2>
                        <p class="mb-2 opacity-75">{{ vendor.business_type|title }} • {{ vendor.service_areas }}</p>
                        <div class="d-flex gap-3">
                            <span><i class="fas fa-star me-1"></i>{{ vendor.rating|default:"4.8" }}</span>
                            <span><i class="fas fa-check-circle me-1"></i>{{ vendor.completion_rate|default:"96" }}% {% trans "Completion Rate" %}</span>
                            <span><i class="fas fa-clock me-1"></i>{{ vendor.avg_response_time|default:"1.2" }}h {% trans "Avg Response" %}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end">
                <div class="d-flex gap-2 justify-content-lg-end">
                    <button class="btn btn-light" onclick="contactVendor()">
                        <i class="fas fa-phone me-1"></i>{% trans "Contact" %}
                    </button>
                    <button class="btn btn-outline-light" onclick="viewProfile()">
                        <i class="fas fa-user me-1"></i>{% trans "View Profile" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignment Metrics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-box">
                <div class="metric-value">{{ total_assignments|default:"247" }}</div>
                <div class="metric-label">{% trans "Total Assignments" %}</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-box">
                <div class="metric-value">{{ active_assignments|default:"12" }}</div>
                <div class="metric-label">{% trans "Active Assignments" %}</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-box">
                <div class="metric-value">{{ successful_assignments|default:"237" }}</div>
                <div class="metric-label">{% trans "Successful" %}</div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="metric-box">
                <div class="metric-value">${{ total_revenue|default:"48,250" }}</div>
                <div class="metric-label">{% trans "Total Revenue" %}</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Assignment History -->
        <div class="col-lg-8 mb-4">
            <div class="assignment-card">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>{% trans "Assignment History" %}
                    </h6>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="statusFilter">
                            <option value="all">{% trans "All Status" %}</option>
                            <option value="active">{% trans "Active" %}</option>
                            <option value="completed">{% trans "Completed" %}</option>
                            <option value="cancelled">{% trans "Cancelled" %}</option>
                        </select>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportAssignments()">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>{% trans "Booking" %}</th>
                                    <th>{% trans "Service" %}</th>
                                    <th>{% trans "Client" %}</th>
                                    <th>{% trans "Date" %}</th>
                                    <th>{% trans "Priority" %}</th>
                                    <th>{% trans "Status" %}</th>
                                    <th>{% trans "Revenue" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment in assignments|default:"" %}
                                <tr>
                                    <td>
                                        <a href="{% url 'bookings:booking_detail' assignment.booking.id %}" class="text-decoration-none">
                                            <strong>#{{ assignment.booking.booking_number }}</strong>
                                        </a>
                                    </td>
                                    <td>{{ assignment.service_type }}</td>
                                    <td>{{ assignment.client_name }}</td>
                                    <td>{{ assignment.assigned_date|date:"M d, Y" }}</td>
                                    <td>
                                        <span class="priority-badge priority-{{ assignment.priority }}">
                                            {{ assignment.priority|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="assignment-status status-{{ assignment.status }}">
                                            {{ assignment.status|title }}
                                        </span>
                                    </td>
                                    <td>${{ assignment.revenue }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td>
                                        <a href="#" class="text-decoration-none">
                                            <strong>#{{ "HW-2024-001"|default:"Loading..." }}</strong>
                                        </a>
                                    </td>
                                    <td>{{ "Wellness Package"|default:"Loading..." }}</td>
                                    <td>{{ "Sarah Johnson"|default:"Loading..." }}</td>
                                    <td>{{ "Mar 15, 2024"|default:"Loading..." }}</td>
                                    <td><span class="priority-badge priority-high">{{ "High"|default:"Loading..." }}</span></td>
                                    <td><span class="assignment-status status-completed">{{ "Completed"|default:"Loading..." }}</span></td>
                                    <td>${{ "450"|default:"Loading..." }}</td>
                                </tr>
                                <tr>
                                    <td>
                                        <a href="#" class="text-decoration-none">
                                            <strong>#{{ "HW-2024-002"|default:"Loading..." }}</strong>
                                        </a>
                                    </td>
                                    <td>{{ "Spa Treatment"|default:"Loading..." }}</td>
                                    <td>{{ "Maria Garcia"|default:"Loading..." }}</td>
                                    <td>{{ "Mar 16, 2024"|default:"Loading..." }}</td>
                                    <td><span class="priority-badge priority-normal">{{ "Normal"|default:"Loading..." }}</span></td>
                                    <td><span class="assignment-status status-active">{{ "Active"|default:"Loading..." }}</span></td>
                                    <td>${{ "320"|default:"Loading..." }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Assignment pagination">
                        <ul class="pagination pagination-sm justify-content-center">
                            <li class="page-item"><a class="page-link" href="#">{% trans "Previous" %}</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">{% trans "Next" %}</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Performance Chart -->
            <div class="assignment-card mb-4">
                <div class="card-header bg-transparent border-0">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>{% trans "Performance Trend" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="performance-chart">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Availability Calendar -->
            <div class="assignment-card mb-4">
                <div class="card-header bg-transparent border-0">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-calendar me-2"></i>{% trans "Availability" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="availability-calendar">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h6 class="mb-0" id="currentMonth">March 2024</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="row text-center mb-2">
                            <div class="col"><small>S</small></div>
                            <div class="col"><small>M</small></div>
                            <div class="col"><small>T</small></div>
                            <div class="col"><small>W</small></div>
                            <div class="col"><small>T</small></div>
                            <div class="col"><small>F</small></div>
                            <div class="col"><small>S</small></div>
                        </div>
                        <div id="calendarGrid">
                            <!-- Calendar grid will be generated by JavaScript -->
                        </div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between">
                                <small><span class="calendar-day available me-1">•</span>{% trans "Available" %}</small>
                                <small><span class="calendar-day busy me-1">•</span>{% trans "Busy" %}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="assignment-card">
                <div class="card-header bg-transparent border-0">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-activity me-2"></i>{% trans "Recent Activity" %}
                    </h6>
                </div>
                <div class="card-body">
                    <div class="assignment-timeline">
                        {% for activity in recent_activity|default:"" %}
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ activity.title }}</h6>
                                    <p class="mb-1 text-muted">{{ activity.description }}</p>
                                    <small class="text-muted">{{ activity.timestamp }}</small>
                                </div>
                                <span class="assignment-status status-{{ activity.status }}">
                                    {{ activity.status|title }}
                                </span>
                            </div>
                        </div>
                        {% empty %}
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ "Assignment Completed"|default:"Loading..." }}</h6>
                                    <p class="mb-1 text-muted">{{ "Wellness package for Sarah Johnson"|default:"Loading..." }}</p>
                                    <small class="text-muted">{{ "2 hours ago"|default:"Loading..." }}</small>
                                </div>
                                <span class="assignment-status status-completed">{{ "Completed"|default:"Loading..." }}</span>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ "New Assignment"|default:"Loading..." }}</h6>
                                    <p class="mb-1 text-muted">{{ "Spa treatment for Maria Garcia"|default:"Loading..." }}</p>
                                    <small class="text-muted">{{ "4 hours ago"|default:"Loading..." }}</small>
                                </div>
                                <span class="assignment-status status-active">{{ "Active"|default:"Loading..." }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializePerformanceChart();
    generateCalendar();
    
    // Set up filter listeners
    document.getElementById('statusFilter').addEventListener('change', filterAssignments);
});

let performanceChart;

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Assignment Score',
                data: [85, 88, 92, 90, 94, 92],
                borderColor: 'rgb(141, 21, 56)',
                backgroundColor: 'rgba(141, 21, 56, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 80,
                    max: 100
                }
            }
        }
    });
}

function generateCalendar() {
    const calendarGrid = document.getElementById('calendarGrid');
    const daysInMonth = 31;
    const startDay = 5; // March 1, 2024 is a Friday (5)
    
    let html = '';
    let dayCount = 1;
    
    // Generate 6 weeks (42 days)
    for (let week = 0; week < 6; week++) {
        html += '<div class="row text-center mb-1">';
        
        for (let day = 0; day < 7; day++) {
            if (week === 0 && day < startDay) {
                html += '<div class="col"><div class="calendar-day"></div></div>';
            } else if (dayCount <= daysInMonth) {
                const isAvailable = Math.random() > 0.3; // Random availability
                const cssClass = isAvailable ? 'available' : 'busy';
                html += `<div class="col"><div class="calendar-day ${cssClass}" onclick="selectDay(${dayCount})">${dayCount}</div></div>`;
                dayCount++;
            } else {
                html += '<div class="col"><div class="calendar-day"></div></div>';
            }
        }
        
        html += '</div>';
    }
    
    calendarGrid.innerHTML = html;
}

function selectDay(day) {
    // Remove previous selection
    document.querySelectorAll('.calendar-day').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Add selection to clicked day
    event.target.classList.add('selected');
    
    // Load day details
    console.log(`Selected day: ${day}`);
}

function previousMonth() {
    // Implementation for previous month
    console.log('Previous month');
}

function nextMonth() {
    // Implementation for next month
    console.log('Next month');
}

function filterAssignments() {
    const selectedStatus = document.getElementById('statusFilter').value;
    // Implementation for filtering assignments
    console.log(`Filter by status: ${selectedStatus}`);
}

function exportAssignments() {
    // Implementation for exporting assignments
    alert('{% trans "Exporting assignments..." %}');
}

function contactVendor() {
    // Implementation for contacting vendor
    alert('{% trans "Contacting vendor..." %}');
}

function viewProfile() {
    // Navigate to vendor profile
    window.location.href = '{% url "vendors:profile_detail" %}';
}
</script>
{% endblock %}