{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load analytics_filters %}

{% block title %}Quality Rankings - Hawwa{% endblock %}

{% block extra_css %}
<style>
    .rankings-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .analytics-card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: transform 0.2s ease-in-out;
    }
    .analytics-card:hover {
        transform: translateY(-2px);
    }
    .ranking-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 10px;
        transition: background-color 0.2s ease;
    }
    .ranking-item:hover {
        background-color: #f8f9fa;
    }
    .rank-badge {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        margin-right: 1rem;
    }
    .rank-1 { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; }
    .rank-2 { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); color: #333; }
    .rank-3 { background: linear-gradient(135deg, #cd7f32, #daa520); color: white; }
    .rank-other { background: linear-gradient(135deg, #6c757d, #8a94a6); color: white; }
    
    .score-display {
        text-align: right;
        min-width: 80px;
    }
    .score-value {
        font-size: 1.5rem;
        font-weight: bold;
    }
    .score-excellent { color: #28a745; }
    .score-good { color: #17a2b8; }
    .score-average { color: #ffc107; }
    .score-poor { color: #dc3545; }
    
    .category-tab {
        border: none;
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
        margin: 0.25rem;
        background-color: #f8f9fa;
        color: #6c757d;
        transition: all 0.2s ease;
    }
    .category-tab.active {
        background-color: #007bff;
        color: white;
    }
    .category-tab:hover {
        background-color: #e9ecef;
    }
    .category-tab.active:hover {
        background-color: #0056b3;
    }
    
    .vendor-info {
        flex-grow: 1;
        margin-left: 1rem;
    }
    .vendor-name {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }
    .vendor-details {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .medal-icon {
        margin-left: 0.5rem;
    }
    
    .stats-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 10px;
        height: 60px;
        margin-bottom: 0.5rem;
    }
    
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Rankings Header -->
    <div class="rankings-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">Quality Rankings</h1>
                <p class="mb-0">
                    <i class="fas fa-trophy me-2"></i>
                    Vendor performance rankings based on comprehensive quality metrics
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-light" onclick="refreshRankings()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <button class="btn btn-light" onclick="exportRankings()">
                        <i class="fas fa-download me-2"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-summary">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 class="mb-1">{{ overall_rankings|length }}</h3>
                        <p class="mb-0">Total Vendors</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="mb-1">
                            {% if overall_rankings %}
                                {{ overall_rankings.0.quality_score|floatformat:1 }}
                            {% else %}
                                N/A
                            {% endif %}
                        </h3>
                        <p class="mb-0">Top Quality Score</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="mb-1">{{ categories|length }}</h3>
                        <p class="mb-0">Service Categories</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="mb-1">
                            {% if overall_rankings %}
                                {% with overall_rankings|slice:":10" as top_ten %}
                                    {{ top_ten|length }}
                                {% endwith %}
                            {% else %}
                                0
                            {% endif %}
                        </h3>
                        <p class="mb-0">Top Performers</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card analytics-card">
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-center">
                        <button class="category-tab active" onclick="showOverallRankings()">
                            <i class="fas fa-trophy me-2"></i>Overall Rankings
                        </button>
                        {% for category in categories %}
                        <button class="category-tab" onclick="showCategoryRankings('{{ category.name|slugify }}')">
                            <i class="fas fa-tools me-2"></i>{{ category.name }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Rankings -->
    <div id="overall-rankings" class="rankings-section">
        <div class="row">
            <div class="col-12">
                <div class="card analytics-card">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Overall Quality Rankings</h6>
                        <small class="text-muted">Updated: {{ "now"|date:"M j, Y g:i A" }}</small>
                    </div>
                    <div class="card-body">
                        {% if overall_rankings %}
                            {% for ranking in overall_rankings %}
                            <div class="ranking-item">
                                <div class="rank-badge {% if ranking.overall_rank == 1 %}rank-1{% elif ranking.overall_rank == 2 %}rank-2{% elif ranking.overall_rank == 3 %}rank-3{% else %}rank-other{% endif %}">
                                    {{ ranking.overall_rank }}
                                    {% if ranking.overall_rank == 1 %}
                                        <i class="fas fa-crown medal-icon"></i>
                                    {% elif ranking.overall_rank == 2 %}
                                        <i class="fas fa-medal medal-icon"></i>
                                    {% elif ranking.overall_rank == 3 %}
                                        <i class="fas fa-award medal-icon"></i>
                                    {% endif %}
                                </div>
                                
                                <div class="vendor-info">
                                    <div class="vendor-name">
                                        <a href="{% url 'analytics:vendor_detail' ranking.vendor.id %}" class="text-decoration-none">
                                            {{ ranking.vendor.business_name }}
                                        </a>
                                    </div>
                                    <div class="vendor-details">
                                        <i class="fas fa-map-marker-alt me-1"></i>{{ ranking.vendor.city }}, {{ ranking.vendor.state }}
                                        {% if ranking.vendor.get_primary_service_display %}
                                            <span class="ms-3">
                                                <i class="fas fa-tools me-1"></i>{{ ranking.vendor.get_primary_service_display }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="score-display">
                                    <div class="score-value {% if ranking.quality_score >= 90 %}score-excellent{% elif ranking.quality_score >= 80 %}score-good{% elif ranking.quality_score >= 70 %}score-average{% else %}score-poor{% endif %}">
                                        {{ ranking.quality_score|floatformat:1 }}
                                    </div>
                                    <small class="text-muted">Quality Score</small>
                                </div>
                                
                                <div class="score-display ms-3">
                                    <div class="score-value text-info">
                                        {{ ranking.customer_satisfaction_score|floatformat:1 }}
                                    </div>
                                    <small class="text-muted">Satisfaction</small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Rankings Available</h5>
                                <p class="text-muted">Rankings will appear here once quality scores are calculated.</p>
                                <button class="btn btn-primary" onclick="generateRankings()">
                                    <i class="fas fa-calculator me-2"></i>Generate Rankings
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Rankings -->
    {% for category in categories %}
    <div id="category-{{ category.name|slugify }}" class="rankings-section" style="display: none;">
        <div class="row">
            <div class="col-12">
                <div class="card analytics-card">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">{{ category.name }} Rankings</h6>
                        <small class="text-muted">Category: {{ category.name }}</small>
                    </div>
                    <div class="card-body">
                        {% with category_rankings|lookup:category.name as rankings %}
                            {% if rankings %}
                                {% for ranking in rankings %}
                                <div class="ranking-item">
                                    <div class="rank-badge {% if ranking.overall_rank == 1 %}rank-1{% elif ranking.overall_rank == 2 %}rank-2{% elif ranking.overall_rank == 3 %}rank-3{% else %}rank-other{% endif %}">
                                        {{ ranking.overall_rank }}
                                        {% if ranking.overall_rank == 1 %}
                                            <i class="fas fa-crown medal-icon"></i>
                                        {% elif ranking.overall_rank == 2 %}
                                            <i class="fas fa-medal medal-icon"></i>
                                        {% elif ranking.overall_rank == 3 %}
                                            <i class="fas fa-award medal-icon"></i>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="vendor-info">
                                        <div class="vendor-name">
                                            <a href="{% url 'analytics:vendor_detail' ranking.vendor.id %}" class="text-decoration-none">
                                                {{ ranking.vendor.business_name }}
                                            </a>
                                        </div>
                                        <div class="vendor-details">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ ranking.vendor.city }}, {{ ranking.vendor.state }}
                                            <span class="ms-3">
                                                <i class="fas fa-tools me-1"></i>{{ category.name }}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="score-display">
                                        <div class="score-value {% if ranking.quality_score >= 90 %}score-excellent{% elif ranking.quality_score >= 80 %}score-good{% elif ranking.quality_score >= 70 %}score-average{% else %}score-poor{% endif %}">
                                            {{ ranking.quality_score|floatformat:1 }}
                                        </div>
                                        <small class="text-muted">Quality Score</small>
                                    </div>
                                    
                                    <div class="score-display ms-3">
                                        <div class="score-value text-info">
                                            {{ ranking.customer_satisfaction_score|floatformat:1 }}
                                        </div>
                                        <small class="text-muted">Satisfaction</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No {{ category.name }} Rankings</h5>
                                    <p class="text-muted">No vendors found in this category with quality scores.</p>
                                </div>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Loading Section -->
    <div id="loading-section" style="display: none;">
        <div class="row">
            <div class="col-12">
                <div class="card analytics-card">
                    <div class="card-body">
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                        <div class="loading-skeleton"></div>
                        <div class="text-center mt-3">
                            <p class="text-muted">Loading rankings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tab switching functionality
function showOverallRankings() {
    // Hide all ranking sections
    document.querySelectorAll('.rankings-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show overall rankings
    document.getElementById('overall-rankings').style.display = 'block';
    
    // Update active tab
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
}

function showCategoryRankings(categorySlug) {
    // Hide all ranking sections
    document.querySelectorAll('.rankings-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Show selected category rankings
    const categorySection = document.getElementById(`category-${categorySlug}`);
    if (categorySection) {
        categorySection.style.display = 'block';
    }
    
    // Update active tab
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Action functions
function refreshRankings() {
    showLoading();
    
    // This would trigger a rankings refresh
    setTimeout(() => {
        hideLoading();
        location.reload();
    }, 2000);
}

function exportRankings() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exporting...';
    btn.disabled = true;
    
    // This would trigger an export process
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        // Create and download a CSV file
        const csvContent = generateRankingsCSV();
        downloadCSV(csvContent, 'quality_rankings.csv');
    }, 1500);
}

function generateRankings() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    btn.disabled = true;
    
    // This would trigger rankings generation
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('Rankings generation started. The page will refresh when complete.');
        location.reload();
    }, 3000);
}

function showLoading() {
    document.querySelectorAll('.rankings-section').forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById('loading-section').style.display = 'block';
}

function hideLoading() {
    document.getElementById('loading-section').style.display = 'none';
    document.getElementById('overall-rankings').style.display = 'block';
}

function generateRankingsCSV() {
    // This would generate actual CSV data from the rankings
    let csv = 'Rank,Vendor Name,City,State,Quality Score,Satisfaction Score\n';
    
    document.querySelectorAll('#overall-rankings .ranking-item').forEach(item => {
        const rank = item.querySelector('.rank-badge').textContent.trim();
        const name = item.querySelector('.vendor-name a').textContent.trim();
        const location = item.querySelector('.vendor-details').textContent.trim();
        const qualityScore = item.querySelector('.score-display .score-value').textContent.trim();
        const satisfactionScore = item.querySelector('.score-display:last-child .score-value').textContent.trim();
        
        // Extract city and state from location string
        const locationParts = location.split(',');
        const city = locationParts[0] ? locationParts[0].trim() : '';
        const state = locationParts[1] ? locationParts[1].trim() : '';
        
        csv += `${rank},"${name}","${city}","${state}",${qualityScore},${satisfactionScore}\n`;
    });
    
    return csv;
}

function downloadCSV(csvContent, fileName) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Auto-refresh rankings every 10 minutes
setInterval(() => {
    refreshRankings();
}, 600000);
</script>
{% endblock %}