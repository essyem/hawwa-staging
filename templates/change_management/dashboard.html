{% extends 'change_management/change_management_base.html' %}
{% load static %}

{% block page_title %}Change Management Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="change-hero">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold mb-3">
                        <i class="fas fa-code-branch me-3"></i>Change Management
                    </h1>
                    <p class="lead mb-4">
                        Monitor and manage organizational changes, incidents, and operational improvements across the HAWWA platform.
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <a href="{% url 'change_management:change_list' %}" class="btn btn-light btn-lg me-3">
                        <i class="fas fa-list me-2"></i>View All Changes
                    </a>
                    <button type="button" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-plus me-2"></i>New Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card changes">
            <div class="stat-icon">
                <i class="fas fa-code-branch"></i>
            </div>
            <div class="stat-number">{{ total_changes }}</div>
            <div class="stat-label">Total Changes</div>
            <div class="mt-2">
                <small class="text-muted">
                    <span class="text-success">+{{ recent_changes }}</span> this month
                </small>
            </div>
        </div>

        <div class="stat-card incidents">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-number">{{ total_incidents }}</div>
            <div class="stat-label">Total Incidents</div>
            <div class="mt-2">
                <small class="text-muted">
                    <span class="text-danger">{{ critical_incidents }}</span> critical
                </small>
            </div>
        </div>

        <div class="stat-card leads">
            <div class="stat-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="stat-number">{{ total_leads }}</div>
            <div class="stat-label">Total Leads</div>
            <div class="mt-2">
                <small class="text-muted">
                    <span class="text-info">+{{ recent_leads }}</span> this month
                </small>
            </div>
        </div>

        <div class="stat-card activity">
            <div class="stat-icon">
                <i class="fas fa-history"></i>
            </div>
            <div class="stat-number">{{ recent_activities }}</div>
            <div class="stat-label">Recent Activities</div>
            <div class="mt-2">
                <small class="text-muted">Last 30 days</small>
            </div>
        </div>
    </div>

    <!-- Dashboard Content Grid -->
    <div class="row">
        <!-- Status Overview -->
        <div class="col-lg-6 mb-4">
            <div class="change-card">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Change Request Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-3">
                            <div class="d-flex align-items-center">
                                <div class="status-badge status-open me-2">Open</div>
                                <span class="fw-bold">{{ open_changes }}</span>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="d-flex align-items-center">
                                <div class="status-badge status-in-progress me-2">In Progress</div>
                                <span class="fw-bold">{{ in_progress_changes }}</span>
                            </div>
                        </div>
                    </div>
                    
                    {% for status in status_stats %}
                    <div class="progress mb-2" style="height: 8px;">
                        {% if status.status == 'OPEN' %}
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: {% widthratio status.count total_changes 100 %}%"
                                 aria-valuenow="{{ status.count }}" aria-valuemin="0" aria-valuemax="{{ total_changes }}">
                            </div>
                        {% elif status.status == 'IN_PROGRESS' %}
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {% widthratio status.count total_changes 100 %}%"
                                 aria-valuenow="{{ status.count }}" aria-valuemin="0" aria-valuemax="{{ total_changes }}">
                            </div>
                        {% elif status.status == 'MERGED' %}
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {% widthratio status.count total_changes 100 %}%"
                                 aria-valuenow="{{ status.count }}" aria-valuemin="0" aria-valuemax="{{ total_changes }}">
                            </div>
                        {% elif status.status == 'CLOSED' %}
                            <div class="progress-bar bg-secondary" role="progressbar" 
                                 style="width: {% widthratio status.count total_changes 100 %}%"
                                 aria-valuenow="{{ status.count }}" aria-valuemin="0" aria-valuemax="{{ total_changes }}">
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="col-lg-6 mb-4">
            <div class="change-card">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>Quick Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="border-start border-4 border-danger ps-3">
                                <div class="fw-bold text-danger h4 mb-1">{{ unresolved_incidents }}</div>
                                <small class="text-muted">Unresolved Incidents</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border-start border-4 border-warning ps-3">
                                <div class="fw-bold text-warning h4 mb-1">{{ critical_incidents }}</div>
                                <small class="text-muted">Critical Issues</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border-start border-4 border-success ps-3">
                                <div class="fw-bold text-success h4 mb-1">{{ recent_changes }}</div>
                                <small class="text-muted">Changes This Month</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border-start border-4 border-info ps-3">
                                <div class="fw-bold text-info h4 mb-1">{{ recent_leads }}</div>
                                <small class="text-muted">New Leads</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Change Requests -->
        <div class="col-lg-8 mb-4">
            <div class="change-card">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-code-branch me-2"></i>Recent Change Requests
                    </h5>
                    <a href="{% url 'change_management:change_list' %}" class="btn btn-sm btn-outline-primary">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    {% for cr in recent_change_requests %}
                    <div class="change-item priority-{% if cr.priority <= 1 %}critical{% elif cr.priority == 2 %}high{% elif cr.priority == 3 %}medium{% else %}low{% endif %}">
                        <div class="change-header">
                            <div class="flex-grow-1">
                                <div class="change-title">
                                    <a href="{% url 'change_management:cr_detail' cr.pk %}" class="text-decoration-none">
                                        CR#{{ cr.id }} - {{ cr.title }}
                                    </a>
                                </div>
                                <div class="change-meta">
                                    <span><i class="fas fa-user me-1"></i>{{ cr.reporter.get_full_name|default:cr.reporter.email|default:"Unknown" }}</span>
                                    <span><i class="fas fa-clock me-1"></i>{{ cr.created_at|date:"M d, Y" }}</span>
                                    {% if cr.assignee %}
                                    <span><i class="fas fa-user-tag me-1"></i>{{ cr.assignee.get_full_name|default:cr.assignee.email }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="status-badge status-{{ cr.status|lower }}">
                                {{ cr.get_status_display }}
                            </div>
                        </div>
                        {% if cr.description %}
                        <div class="change-description">
                            {{ cr.description|truncatewords:20 }}
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                        No change requests found.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="col-lg-4 mb-4">
            <div class="change-card">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Activity Log
                    </h5>
                    <a href="{% url 'change_management:activity_list' %}" class="btn btn-sm btn-outline-primary">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="activity-timeline">
                        {% for activity in recent_activity_log %}
                        <div class="timeline-item">
                            <div class="timeline-icon">
                                {% if 'assign' in activity.verb %}
                                    <i class="fas fa-user-tag"></i>
                                {% elif 'comment' in activity.verb %}
                                    <i class="fas fa-comment"></i>
                                {% elif 'create' in activity.verb %}
                                    <i class="fas fa-plus"></i>
                                {% elif 'update' in activity.verb %}
                                    <i class="fas fa-edit"></i>
                                {% else %}
                                    <i class="fas fa-activity"></i>
                                {% endif %}
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-title">
                                    {{ activity.actor.get_full_name|default:activity.actor.email|default:"System" }}
                                </div>
                                <div class="timeline-desc">
                                    {{ activity.verb|title }} {{ activity.target|default:"" }}
                                </div>
                                <div class="timeline-time">
                                    {{ activity.created_at|timesince }} ago
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center py-3 text-muted">
                            No recent activities.
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="change-card">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="#" class="btn btn-change w-100 d-flex align-items-center justify-content-center">
                                <i class="fas fa-plus me-2"></i>New Change Request
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="#" class="btn btn-change w-100 d-flex align-items-center justify-content-center">
                                <i class="fas fa-exclamation-triangle me-2"></i>Report Incident
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'change_management:role_list' %}" class="btn btn-change w-100 d-flex align-items-center justify-content-center">
                                <i class="fas fa-user-shield me-2"></i>Manage Roles
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'change_management:activity_list' %}" class="btn btn-change w-100 d-flex align-items-center justify-content-center">
                                <i class="fas fa-chart-line me-2"></i>View Reports
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}